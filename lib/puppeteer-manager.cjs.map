{"version":3,"file":"puppeteer-manager.cjs","sources":["../src/index.ts"],"sourcesContent":["import puppeteer, {\n  type Browser,\n  type PuppeteerLaunchOptions,\n} from \"puppeteer\";\nimport { default as Semaphore } from \"@chriscdn/promise-semaphore\";\n\n// https://github.com/GoogleChrome/puppeteer/issues/661\n// for --font-render-hinting=none - seems to fix inconsistent letter spacing between linux and everything else\n// pipe : // https://github.com/GoogleChrome/puppeteer/issues/2735\nconst defaultPuppeteerOptions: PuppeteerLaunchOptions = {\n  pipe: true,\n  args: [\n    \"--no-sandbox\",\n    \"--disable-setuid-sandbox\",\n    \"--use-gl=desktop\",\n    \"--font-render-hinting=none\",\n  ],\n  dumpio: true,\n  ignoreHTTPSErrors: true,\n};\n\nclass PuppeteerManager {\n  puppeteerOptions: PuppeteerLaunchOptions;\n  _browser: Browser | null;\n  timeoutId: NodeJS.Timeout | undefined;\n  timeout: number;\n  newPageSemaphore: Semaphore;\n  openCloseSemaphore: Semaphore;\n\n  constructor({\n    puppeteerOptions = defaultPuppeteerOptions,\n    pageLimit = 4,\n    timeout = 30000, // 30s\n  }: {\n    puppeteerOptions?: PuppeteerLaunchOptions;\n    pageLimit?: number;\n    timeout?: number;\n  } = {}) {\n    this.puppeteerOptions = puppeteerOptions;\n    this._browser = null;\n    this.timeoutId = undefined;\n    this.timeout = timeout;\n\n    // limit the number of open tabs\n    this.newPageSemaphore = new Semaphore(pageLimit);\n\n    // Handles the extremely rare case when a new browser or page is being requested at the exact\n    // moment a cleanup call is being made.\n    this.openCloseSemaphore = new Semaphore();\n  }\n\n  // Never call this externally.\n  private async browser() {\n    if (this._browser === null) {\n      console.log(\"Puppeteer Started\");\n      this._browser = await puppeteer.launch(this.puppeteerOptions);\n    }\n\n    this.tap();\n\n    return this._browser;\n  }\n\n  /**\n   * A lightweight debounce to check if the browser can be shutdown.\n   */\n  tap() {\n    clearTimeout(this.timeoutId);\n    this.timeoutId = setTimeout(this.closeBrowser.bind(this), this.timeout);\n  }\n\n  async closeBrowser() {\n    try {\n      await this.openCloseSemaphore.acquire();\n\n      // Puppeteer starts with 1 blank tab open.\n      if (this.isBrowserOpen && (await this.pageCount()) <= 1) {\n        const browser = this._browser;\n        this._browser = null;\n        await browser!.close();\n        console.log(\"Puppeteer Closed\");\n      } else {\n        // console.log('Not ready to close.')\n        this.tap();\n      }\n    } finally {\n      this.openCloseSemaphore.release();\n    }\n  }\n\n  get isBrowserOpen() {\n    return Boolean(this._browser);\n  }\n\n  async newPage() {\n    try {\n      // limit the number of open tabs\n      await this.newPageSemaphore.acquire();\n\n      // prevents a closeBrowser() call from destroying this while doing async stuff\n      // like calling browser() or newPage()\n      await this.openCloseSemaphore.acquire();\n      const browser = await this.browser();\n      const page = await browser.newPage();\n\n      page.on(\"close\", () => this.newPageSemaphore.release());\n\n      return page;\n    } finally {\n      this.openCloseSemaphore.release();\n      // this.newPageSemaphore.release()\n    }\n  }\n\n  async pageCount() {\n    if (this.isBrowserOpen) {\n      const pages = await this._browser!.pages();\n      return pages.length;\n    } else {\n      return 0;\n    }\n  }\n}\n\nexport default PuppeteerManager;\n"],"names":["defaultPuppeteerOptions","pipe","args","dumpio","ignoreHTTPSErrors","PuppeteerManager","_temp","_ref","_ref$puppeteerOptions","puppeteerOptions","_ref$pageLimit","pageLimit","_ref$timeout","timeout","this","_browser","timeoutId","newPageSemaphore","openCloseSemaphore","undefined","Semaphore","_proto","prototype","browser","_temp3","_this","tap","_temp2","console","log","Promise","resolve","puppeteer","launch","then","_puppeteer$launch","e","reject","clearTimeout","setTimeout","closeBrowser","bind","_this2","_temp6","_finallyRethrows","acquire","_temp5","_this2$pageCount","_temp4","_this2$isBrowserOpen","close","isBrowserOpen","pageCount","_wasThrown","_result","release","newPage","_this3","page","on","_wasThrown2","_result2","pages","length","_createClass","key","get","Boolean"],"mappings":"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"}