{"version":3,"file":"puppeteer-manager.modern.js","sources":["../src/index.ts"],"sourcesContent":["import puppeteer, { type Browser, type LaunchOptions } from \"puppeteer\";\n\nimport { Semaphore } from \"@chriscdn/promise-semaphore\";\n\n// https://github.com/GoogleChrome/puppeteer/issues/661\n// for --font-render-hinting=none - seems to fix inconsistent letter spacing between linux and everything else\n// pipe : // https://github.com/GoogleChrome/puppeteer/issues/2735\nconst defaultPuppeteerOptions: LaunchOptions = {\n  pipe: true,\n  args: [\n    \"--no-sandbox\",\n    \"--disable-setuid-sandbox\",\n    \"--use-gl=desktop\",\n    \"--font-render-hinting=none\",\n  ],\n  dumpio: true,\n  acceptInsecureCerts: true,\n};\n\nclass PuppeteerManager {\n  puppeteerOptions: LaunchOptions;\n  _browser: Browser | null;\n  timeoutId: NodeJS.Timeout | undefined;\n  timeout: number;\n  newPageSemaphore: Semaphore;\n  openCloseSemaphore: Semaphore;\n\n  constructor({\n    puppeteerOptions = defaultPuppeteerOptions,\n    pageLimit = 4,\n    timeout = 30000, // 30s\n  }: {\n    puppeteerOptions?: LaunchOptions;\n    pageLimit?: number;\n    timeout?: number;\n  } = {}) {\n    this.puppeteerOptions = puppeteerOptions;\n    this._browser = null;\n    this.timeoutId = undefined;\n    this.timeout = timeout;\n\n    // limit the number of open tabs\n    this.newPageSemaphore = new Semaphore(pageLimit);\n\n    // Handles the extremely rare case when a new browser or page is being requested at the exact\n    // moment a cleanup call is being made.\n    this.openCloseSemaphore = new Semaphore();\n  }\n\n  // Never call this externally.\n  private async browser() {\n    if (this._browser === null) {\n      console.log(\"Puppeteer Started\");\n      this._browser = await puppeteer.launch(this.puppeteerOptions);\n    }\n\n    this.tap();\n\n    return this._browser;\n  }\n\n  /**\n   * A lightweight debounce to check if the browser can be shutdown.\n   */\n  tap() {\n    clearTimeout(this.timeoutId);\n    this.timeoutId = setTimeout(this.closeBrowser.bind(this), this.timeout);\n  }\n\n  /**\n   * May need to revisit this. Are there cases when the browser refused to close?\n   *\n   * https://www.codepasta.com/2024/04/19/optimizing-puppeteer-pdf-generation\n   */\n  async closeBrowser() {\n    try {\n      await this.openCloseSemaphore.acquire();\n\n      // Puppeteer starts with 1 blank tab open.\n      if (this.isBrowserOpen && (await this.pageCount()) <= 1) {\n        const browser = this._browser;\n        this._browser = null;\n        await browser.close();\n        console.log(\"Puppeteer Closed\");\n      } else {\n        // console.log('Not ready to close.')\n        this.tap();\n      }\n    } finally {\n      this.openCloseSemaphore.release();\n    }\n  }\n\n  get isBrowserOpen() {\n    return Boolean(this._browser);\n  }\n\n  async newPage() {\n    try {\n      // limit the number of open tabs\n      await this.newPageSemaphore.acquire();\n\n      // prevents a closeBrowser() call from destroying this while doing async stuff\n      // like calling browser() or newPage()\n      await this.openCloseSemaphore.acquire();\n      const browser = await this.browser();\n      const page = await browser.newPage();\n\n      page.on(\"close\", () => this.newPageSemaphore.release());\n\n      return page;\n    } finally {\n      this.openCloseSemaphore.release();\n      // this.newPageSemaphore.release()\n    }\n  }\n\n  async pageCount() {\n    if (this.isBrowserOpen) {\n      const pages = await this._browser!.pages();\n      return pages.length;\n    } else {\n      return 0;\n    }\n  }\n}\n\nexport { puppeteer, PuppeteerManager };\n\nexport * from \"puppeteer\";\n"],"names":["defaultPuppeteerOptions","pipe","args","dumpio","acceptInsecureCerts","PuppeteerManager","constructor","puppeteerOptions","pageLimit","timeout","this","_browser","timeoutId","newPageSemaphore","openCloseSemaphore","undefined","Semaphore","browser","console","log","puppeteer","launch","tap","clearTimeout","setTimeout","closeBrowser","bind","acquire","isBrowserOpen","pageCount","close","release","Boolean","newPage","page","on","pages","length"],"mappings":"oJAOA,MAAMA,EAAyC,CAC7CC,MAAM,EACNC,KAAM,CACJ,eACA,2BACA,mBACA,8BAEFC,QAAQ,EACRC,qBAAqB,GAGvB,MAAMC,EAQJC,WAAAA,EAAYC,iBACVA,EAAmBP,EAAuBQ,UAC1CA,EAAY,EAACC,QACbA,EAAU,KAKR,SAfJF,sBAAgB,EAAAG,KAChBC,cACAC,EAAAA,KAAAA,sBACAH,aAAO,EAAAC,KACPG,sBAAgB,EAAAH,KAChBI,wBAAkB,EAWhBJ,KAAKH,iBAAmBA,EACxBG,KAAKC,SAAW,KAChBD,KAAKE,eAAYG,EACjBL,KAAKD,QAAUA,EAGfC,KAAKG,iBAAmB,IAAIG,EAAUR,GAItCE,KAAKI,mBAAqB,IAAIE,CAChC,CAGQ,aAAMC,GAQZ,OAPsB,OAAlBP,KAAKC,WACPO,QAAQC,IAAI,qBACZT,KAAKC,eAAiBS,EAAUC,OAAOX,KAAKH,mBAG9CG,KAAKY,WAEOX,QACd,CAKAW,GAAAA,GACEC,aAAab,KAAKE,WAClBF,KAAKE,UAAYY,WAAWd,KAAKe,aAAaC,KAAKhB,MAAOA,KAAKD,QACjE,CAOA,kBAAMgB,GACJ,IAIE,SAHMf,KAAKI,mBAAmBa,UAG1BjB,KAAKkB,qBAAwBlB,KAAKmB,aAAgB,EAAG,CACvD,MAAMZ,EAAUP,KAAKC,SACrBD,KAAKC,SAAW,WACVM,EAAQa,QACdZ,QAAQC,IAAI,mBACb,MAECT,KAAKY,KAER,CAAA,QACCZ,KAAKI,mBAAmBiB,SACzB,CACH,CAEA,iBAAIH,GACF,OAAOI,QAAQtB,KAAKC,SACtB,CAEA,aAAMsB,GACJ,UAEYvB,KAACG,iBAAiBc,gBAIlBjB,KAACI,mBAAmBa,UAC9B,MAAMV,QAAoBP,KAACO,UACrBiB,QAAajB,EAAQgB,UAI3B,OAFAC,EAAKC,GAAG,QAAS,IAAMzB,KAAKG,iBAAiBkB,WAEtCG,CACR,CAAA,QACCxB,KAAKI,mBAAmBiB,SAEzB,CACH,CAEA,eAAMF,GACJ,OAAInB,KAAKkB,qBACiBlB,KAACC,SAAUyB,SACtBC,OAEN,CAEX"}