{"version":3,"file":"puppeteer-manager.modern.js","sources":["../src/index.ts"],"sourcesContent":["import puppeteer, {\n  type Browser,\n  type PuppeteerLaunchOptions,\n} from \"puppeteer\";\n\nimport Semaphore from \"@chriscdn/promise-semaphore\";\n\n// https://github.com/GoogleChrome/puppeteer/issues/661\n// for --font-render-hinting=none - seems to fix inconsistent letter spacing between linux and everything else\n// pipe : // https://github.com/GoogleChrome/puppeteer/issues/2735\nconst defaultPuppeteerOptions: PuppeteerLaunchOptions = {\n  pipe: true,\n  args: [\n    \"--no-sandbox\",\n    \"--disable-setuid-sandbox\",\n    \"--use-gl=desktop\",\n    \"--font-render-hinting=none\",\n  ],\n  dumpio: true,\n  ignoreHTTPSErrors: true,\n};\n\nclass PuppeteerManager {\n  puppeteerOptions: PuppeteerLaunchOptions;\n  _browser: Browser | null;\n  timeoutId: NodeJS.Timeout | undefined;\n  timeout: number;\n  newPageSemaphore: Semaphore;\n  openCloseSemaphore: Semaphore;\n\n  constructor({\n    puppeteerOptions = defaultPuppeteerOptions,\n    pageLimit = 4,\n    timeout = 30000, // 30s\n  }: {\n    puppeteerOptions?: PuppeteerLaunchOptions;\n    pageLimit?: number;\n    timeout?: number;\n  } = {}) {\n    this.puppeteerOptions = puppeteerOptions;\n    this._browser = null;\n    this.timeoutId = undefined;\n    this.timeout = timeout;\n\n    // limit the number of open tabs\n    this.newPageSemaphore = new Semaphore(pageLimit);\n\n    // Handles the extremely rare case when a new browser or page is being requested at the exact\n    // moment a cleanup call is being made.\n    this.openCloseSemaphore = new Semaphore();\n  }\n\n  // Never call this externally.\n  private async browser() {\n    if (this._browser === null) {\n      console.log(\"Puppeteer Started\");\n      this._browser = await puppeteer.launch(this.puppeteerOptions);\n    }\n\n    this.tap();\n\n    return this._browser;\n  }\n\n  /**\n   * A lightweight debounce to check if the browser can be shutdown.\n   */\n  tap() {\n    clearTimeout(this.timeoutId);\n    this.timeoutId = setTimeout(this.closeBrowser.bind(this), this.timeout);\n  }\n\n  /**\n   * May need to revisit this. Are there cases when the browser refused to close?\n   *\n   * https://www.codepasta.com/2024/04/19/optimizing-puppeteer-pdf-generation\n   */\n  async closeBrowser() {\n    try {\n      await this.openCloseSemaphore.acquire();\n\n      // Puppeteer starts with 1 blank tab open.\n      if (this.isBrowserOpen && (await this.pageCount()) <= 1) {\n        const browser = this._browser;\n        this._browser = null;\n        await browser.close();\n        console.log(\"Puppeteer Closed\");\n      } else {\n        // console.log('Not ready to close.')\n        this.tap();\n      }\n    } finally {\n      this.openCloseSemaphore.release();\n    }\n  }\n\n  get isBrowserOpen() {\n    return Boolean(this._browser);\n  }\n\n  async newPage() {\n    try {\n      // limit the number of open tabs\n      await this.newPageSemaphore.acquire();\n\n      // prevents a closeBrowser() call from destroying this while doing async stuff\n      // like calling browser() or newPage()\n      await this.openCloseSemaphore.acquire();\n      const browser = await this.browser();\n      const page = await browser.newPage();\n\n      page.on(\"close\", () => this.newPageSemaphore.release());\n\n      return page;\n    } finally {\n      this.openCloseSemaphore.release();\n      // this.newPageSemaphore.release()\n    }\n  }\n\n  async pageCount() {\n    if (this.isBrowserOpen) {\n      const pages = await this._browser!.pages();\n      return pages.length;\n    } else {\n      return 0;\n    }\n  }\n}\n\nexport { puppeteer, PuppeteerManager };\n\nexport * from \"puppeteer\";\n"],"names":["defaultPuppeteerOptions","pipe","args","dumpio","ignoreHTTPSErrors","PuppeteerManager","constructor","puppeteerOptions","pageLimit","timeout","_browser","this","timeoutId","newPageSemaphore","openCloseSemaphore","undefined","Semaphore","browser","console","log","puppeteer","launch","tap","clearTimeout","setTimeout","closeBrowser","bind","acquire","isBrowserOpen","pageCount","close","release","Boolean","newPage","page","on","pages","length"],"mappings":"uIAUA,MAAMA,EAAkD,CACtDC,MAAM,EACNC,KAAM,CACJ,eACA,2BACA,mBACA,8BAEFC,QAAQ,EACRC,mBAAmB,GAGrB,MAAMC,EAQJC,WAAAA,EAAYC,iBACVA,EAAmBP,EAAuBQ,UAC1CA,EAAY,EAACC,QACbA,EAAU,KAKR,IAfJF,KAAAA,6BACAG,cAAQ,EAAAC,KACRC,eACAH,EAAAA,KAAAA,aACAI,EAAAA,KAAAA,sBACAC,EAAAA,KAAAA,0BAWEH,KAAKJ,iBAAmBA,EACxBI,KAAKD,SAAW,KAChBC,KAAKC,eAAYG,EACjBJ,KAAKF,QAAUA,EAGfE,KAAKE,iBAAmB,IAAIG,EAAUR,GAItCG,KAAKG,mBAAqB,IAAIE,CAChC,CAGQ,aAAMC,GAQZ,OAPsB,OAAlBN,KAAKD,WACPQ,QAAQC,IAAI,qBACZR,KAAKD,eAAiBU,EAAUC,OAAOV,KAAKJ,mBAG9CI,KAAKW,MAEMX,KAACD,QACd,CAKAY,GAAAA,GACEC,aAAaZ,KAAKC,WAClBD,KAAKC,UAAYY,WAAWb,KAAKc,aAAaC,KAAKf,MAAOA,KAAKF,QACjE,CAOA,kBAAMgB,GACJ,IAIE,SAHUd,KAACG,mBAAmBa,UAG1BhB,KAAKiB,0BAA6BC,aAAgB,EAAG,CACvD,MAAMZ,EAAUN,KAAKD,SACrBC,KAAKD,SAAW,WACVO,EAAQa,QACdZ,QAAQC,IAAI,mBACb,MAECR,KAAKW,KAER,CAAA,QACCX,KAAKG,mBAAmBiB,SACzB,CACH,CAEA,iBAAIH,GACF,OAAOI,QAAQrB,KAAKD,SACtB,CAEA,aAAMuB,GACJ,UAEYtB,KAACE,iBAAiBc,gBAIlBhB,KAACG,mBAAmBa,UAC9B,MAAMV,QAAoBN,KAACM,UACrBiB,QAAajB,EAAQgB,UAI3B,OAFAC,EAAKC,GAAG,QAAS,IAAMxB,KAAKE,iBAAiBkB,WAEtCG,CACR,CAAA,QACCvB,KAAKG,mBAAmBiB,SAEzB,CACH,CAEA,eAAMF,GACJ,OAAIlB,KAAKiB,qBACiBjB,KAACD,SAAU0B,SACtBC,OAEN,CAEX"}