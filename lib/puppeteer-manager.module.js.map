{"version":3,"file":"puppeteer-manager.module.js","sources":["../src/index.ts"],"sourcesContent":["import puppeteer, { type Browser, type LaunchOptions } from \"puppeteer\";\n\nimport { Semaphore } from \"@chriscdn/promise-semaphore\";\n\n// https://github.com/GoogleChrome/puppeteer/issues/661\n// for --font-render-hinting=none - seems to fix inconsistent letter spacing between linux and everything else\n// pipe : // https://github.com/GoogleChrome/puppeteer/issues/2735\nconst defaultPuppeteerOptions: LaunchOptions = {\n  pipe: true,\n  args: [\n    \"--no-sandbox\",\n    \"--disable-setuid-sandbox\",\n    \"--use-gl=desktop\",\n    \"--font-render-hinting=none\",\n  ],\n  dumpio: true,\n  acceptInsecureCerts: true,\n};\n\nclass PuppeteerManager {\n  puppeteerOptions: LaunchOptions;\n  _browser: Browser | null;\n  timeoutId: NodeJS.Timeout | undefined;\n  timeout: number;\n  newPageSemaphore: Semaphore;\n  openCloseSemaphore: Semaphore;\n\n  constructor({\n    puppeteerOptions = defaultPuppeteerOptions,\n    pageLimit = 4,\n    timeout = 30000, // 30s\n  }: {\n    puppeteerOptions?: LaunchOptions;\n    pageLimit?: number;\n    timeout?: number;\n  } = {}) {\n    this.puppeteerOptions = puppeteerOptions;\n    this._browser = null;\n    this.timeoutId = undefined;\n    this.timeout = timeout;\n\n    // limit the number of open tabs\n    this.newPageSemaphore = new Semaphore(pageLimit);\n\n    // Handles the extremely rare case when a new browser or page is being requested at the exact\n    // moment a cleanup call is being made.\n    this.openCloseSemaphore = new Semaphore();\n  }\n\n  // Never call this externally.\n  private async browser() {\n    if (this._browser === null) {\n      console.log(\"Puppeteer Started\");\n      this._browser = await puppeteer.launch(this.puppeteerOptions);\n    }\n\n    this.tap();\n\n    return this._browser;\n  }\n\n  /**\n   * A lightweight debounce to check if the browser can be shutdown.\n   */\n  tap() {\n    clearTimeout(this.timeoutId);\n    this.timeoutId = setTimeout(this.closeBrowser.bind(this), this.timeout);\n  }\n\n  /**\n   * May need to revisit this. Are there cases when the browser refused to close?\n   *\n   * https://www.codepasta.com/2024/04/19/optimizing-puppeteer-pdf-generation\n   */\n  async closeBrowser() {\n    try {\n      await this.openCloseSemaphore.acquire();\n\n      // Puppeteer starts with 1 blank tab open.\n      if (this.isBrowserOpen && (await this.pageCount()) <= 1) {\n        const browser = this._browser;\n        this._browser = null;\n        await browser.close();\n        console.log(\"Puppeteer Closed\");\n      } else {\n        // console.log('Not ready to close.')\n        this.tap();\n      }\n    } finally {\n      this.openCloseSemaphore.release();\n    }\n  }\n\n  get isBrowserOpen() {\n    return Boolean(this._browser);\n  }\n\n  async newPage() {\n    try {\n      // limit the number of open tabs\n      await this.newPageSemaphore.acquire();\n\n      // prevents a closeBrowser() call from destroying this while doing async stuff\n      // like calling browser() or newPage()\n      await this.openCloseSemaphore.acquire();\n      const browser = await this.browser();\n      const page = await browser.newPage();\n\n      page.on(\"close\", () => this.newPageSemaphore.release());\n\n      return page;\n    } finally {\n      this.openCloseSemaphore.release();\n      // this.newPageSemaphore.release()\n    }\n  }\n\n  async pageCount() {\n    if (this.isBrowserOpen) {\n      const pages = await this._browser!.pages();\n      return pages.length;\n    } else {\n      return 0;\n    }\n  }\n}\n\nexport { puppeteer, PuppeteerManager };\n\nexport * from \"puppeteer\";\n"],"names":["defaultPuppeteerOptions","pipe","args","dumpio","acceptInsecureCerts","PuppeteerManager","_temp","_ref","_ref$puppeteerOptions","puppeteerOptions","_ref$pageLimit","pageLimit","_ref$timeout","timeout","this","_browser","timeoutId","newPageSemaphore","openCloseSemaphore","undefined","Semaphore","_proto","prototype","browser","_temp3","_this","tap","_temp2","console","log","Promise","resolve","puppeteer","launch","then","_puppeteer$launch","e","reject","clearTimeout","setTimeout","closeBrowser","bind","_this2","_temp6","_finallyRethrows","acquire","_temp5","_this2$pageCount","_temp4","_this2$isBrowserOpen","close","isBrowserOpen","pageCount","_wasThrown","_result","release","newPage","_this3","page","on","_wasThrown2","_result2","pages","length","key","get","Boolean"],"mappings":"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"}